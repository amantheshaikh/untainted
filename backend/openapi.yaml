openapi: 3.0.3
info:
  title: Untainted API
  version: 1.0.0
  description: |
    Untainted provides a robust **food intelligence layer** for platforms.
    Our API enables quick-commerce, grocery, and health apps to deliver personalized safety checks for millions of users.

    ## Authentication
    This API requires an API key for all secure endpoints.
    Include your key in the `x-api-key` header of your request.
    
    Keys come in two variants:
    - **Live (`sk_live_...`)**: Production environment. Hits are billed and affect production data.
    - **Test (`sk_test_...`)**: Sandbox environment. Use these for development and testing integration.

    ## Core Capability: Safety Checks
    The `/check` endpoint is the heart of the Untainted stack. It determines if a product is "safe" or "not_safe" for a specific customer based on their unique profile (diets, allergies, health goals).

    **Workflow:**
    1.  **Identify**: Analyze a product's ingredient list.
    2.  **Contextualize**: Apply the customer's specific profile (passed as preferences or via UID).
    3.  **Decide**: Receive a binary `status` ("safe" | "not_safe") along with detailed conflict reasoning.

    ## Product Contribution
    Untainted maintains a comprehensive database of food products.
    We encourage partners to contribute missing data to expand the shared intelligence network.

    **Submission Workflow:**
    1.  **Lookup**: Call `/product/lookup` with a barcode.
    2.  **Not Found**: If you receive a `404 Not Found`, proceed to step 3.
    3.  **Submit**: Call `/product/missing` (POST) with the barcode and details.
    
    Data submitted is validated before merging into the master dataset.

  contact:
    name: Untainted
    url: https://untainted.io

servers:
  - url: https://api.untainted.io
    description: Production API (Fly.io)

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key


  schemas:
    CheckRequest:
      type: object
      required:
        - ingredients
      properties:
        ingredients:
          type: string
          description: Raw ingredient text (one or multiple lines) or pasted list
        preferences:
          type: object
          description: Optional user preferences, allergies or diet constraints
        customer_uid:
          type: string
          description: Optional UID of the customer to fetch profile from (overrides preferences)

    Reason:
      type: object
      properties:
        ingredient:
          type: string
        category:
          type: string
        conflicts_with:
          type: array
          items:
            type: string

    AnalysisResponse:
      type: object
      properties:
        product:
          type: string
          nullable: true
        verdict:
          type: string
          description: SAFE | CAUTION | NOT_SAFE
        confidence:
          type: number
          format: float
          description: 0..1
        flagged_ingredients:
          type: array
          items:
            type: string
        reasons:
          type: array
          items:
            $ref: '#/components/schemas/Reason'
        safe_alternatives:
          type: array
          items:
            type: string
        processing_time_ms:
          type: integer
          format: int32
        raw:
          type: object
          description: Raw diagnostic payload (taxonomies, hits, etc.)

    ProductLookupRequest:
      type: object
      required:
        - barcode
      properties:
        barcode:
          type: string
          description: GTIN / barcode string

    Product:
      type: object
      properties:
        code:
          type: string
        name:
          type: string
        ingredients:
          type: array
          items:
            type: string
        image_url:
          type: string
        meta:
          type: object

    ProductSubmissionRequest:
      type: object
      required:
        - barcode
      properties:
        barcode:
          type: string
          description: GTIN / barcode string
        name:
          type: string
        brand:
          type: string
        ingredients_text:
          type: string
        categories:
          type: array
          items:
            type: string
        image_url:
          type: string

    OCRResponse:
      type: object
      properties:
        text:
          type: string
        confidence:
          type: number

security:
  - ApiKeyAuth: []

paths:
  /healthz:
    get:
      summary: Health check
      operationId: checkHealth
      tags:
        - System
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /capabilities:
    get:
      summary: Service capabilities / feature flags
      operationId: getCapabilities
      tags:
        - System
      responses:
        '200':
          description: Capabilities
          content:
            application/json:
              schema:
                type: object

  /check:
    post:
      summary: Analyze ingredient list
      operationId: performCheck
      tags:
         - Safety
      description: |
        Primary analysis endpoint. Accepts application/json or form-encoded data.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckRequest'
          application/x-www-form-urlencoded:
            schema:
              $ref: '#/components/schemas/CheckRequest'
      responses:
        '200':
          description: Analysis result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisResponse'
        '400':
          description: Bad request
        '500':
          description: Internal error

  /product/lookup:
    post:
      summary: Lookup product
      operationId: lookupProduct
      tags:
        - Products
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductLookupRequest'
      responses:
        '200':
          description: Product found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          description: Product not found

  /product/missing:
    post:
      summary: Submit missing product
      operationId: submitMissingProduct
      tags:
        - Products
      description: |
        Use this endpoint when a /product/lookup returns 404.
        Contributed data allows us to expand our dataset coverage.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductSubmissionRequest'
      responses:
        '201':
          description: Submission accepted and queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
        '400':
          description: Invalid data (missing barcode)

  /ocr:
    post:
      summary: OCR extraction
      operationId: extractOCR
      tags:
        - Products
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: OCR result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OCRResponse'
        '400':
          description: Invalid upload




